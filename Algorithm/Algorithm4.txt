This is algorithm 4.
This is algorithm 3.
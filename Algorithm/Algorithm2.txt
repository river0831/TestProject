This is algorithm 2.